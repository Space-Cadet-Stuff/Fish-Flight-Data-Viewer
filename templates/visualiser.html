<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fish Flight Data Viewer </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/' + (session.get('theme') or 'halo.css')) }}">
</head>
<body>
    <header>
        <h1><a href="{{ url_for('dashboard') }}">Fish Flight</a></h1>
        <div class="header-buttons">
            <a href="{{ url_for('logout') }}" class="button">Logout</a>
            <a href="{{ url_for('upload') }}" class="button">Upload Data</a>
            <a href="{{ url_for('account_settings') }}" class="button">Account Settings</a>
            <div class="dropdown">
                <a class="button" onclick="toggleThemeMenu()">Change Theme</a>
            </div>
        </div>
    </header>
    <main>
        <div class="content-box-visualiser">
            <div style="display: flex; height: 200%;">
                <div> 
                    <h3>Your CSV Files</h3>
                    <ul>
                        {% if csv_data %}
                            {% for csv in csv_data %}
                                <li class="visualiser-selector">
                                    <div class="title-box"><strong>{{ csv.title }}</strong>:<input type="checkbox" class="selector" data-file-id="{{ csv.id }}"></input></div>
                                    <br>
                                    <small>{{ csv.launch_date }} | {{ csv.engine_class }}</small>
                                    <hr style="margin: 16px 0;">
                                    <ul style="margin-top: 2px; margin-bottom: 2px; padding-left: 18px; font-size: 0.9em; line-height: 1.2;">
                                        {% for header in csv.headers %}
                                            <li style="margin-bottom: 0; padding: 0;">{{ header }}</li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li>No CSVs uploaded yet.</li>
                        {% endif %}
                    </ul>
                </div>
                <div style="flex: 2; padding: 16px;">
                    <canvas id="Graph" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
    </main>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-container">
        {% for category, message in messages %}
        <div class="flash-message {{ category }} fade-in" onclick="dismissAlert(this)">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <div class="dropdown-content" id="themeMenu" style="position: absolute; top: 70px; right: 20px;">
        <form method="POST" action="{{ url_for('set_theme') }}">
            <button type="submit" name="theme" value="halo.css" class="button">UNSC</button>
            <button type="submit" name="theme" value="blade_runner.css" class="button">Tyrell</button>
            <button type="submit" name="theme" value="tron.css" class="button">ENCOM</button>
        </form>
    </div>
    <script src="static/js/scripts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('Graph').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: []
            },
            options: {
                responsive: true,
                parsing: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Flight Telemetry'
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Time (ms)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });

        const loadedFiles = {}; // Cache loaded CSVs to avoid re-fetching

        document.querySelectorAll('.selector').forEach(checkbox => {
            checkbox.addEventListener('change', async () => {
                const fileId = checkbox.dataset.fileId;

                if (checkbox.checked) {
                    // Fetch + plot the CSV
                    if (!loadedFiles[fileId]) {
                        const res = await fetch(`/get_csv_data/${fileId}`);
                        const data = await res.json();
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        loadedFiles[fileId] = data;
                    }

                    const rows = loadedFiles[fileId];
                    const keys = Object.keys(rows[0]);
                    const timeKey = keys.find(k => k.toLowerCase().includes("time")) || keys[0];

                    // Add each non-time column as a dataset
                    keys.forEach(col => {
                        if (col === timeKey) return;
                        const dataset = {
                            label: `${col} (File ${fileId})`,
                            data: rows.map(r => ({
                                x: parseFloat(r[timeKey]),
                                y: parseFloat(r[col])
                            })),
                            borderWidth: 2,
                            tension: 0.2,
                            fileId: fileId,
                            column: col
                        };
                        chart.data.datasets.push(dataset);
                    });

                    chart.update();
                } else {
                    // Remove datasets for this file
                    chart.data.datasets = chart.data.datasets.filter(ds => ds.fileId !== fileId);
                    chart.update();
                }
            });
        });
    </script>
</body>
</html>